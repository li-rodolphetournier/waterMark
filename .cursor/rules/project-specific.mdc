---
description: R√®gles sp√©cifiques au projet CestMonImage / Watermark App
globs: ["watermark_app.py", "build_exe.py", "**/*.spec"]
alwaysApply: true
---

# üñºÔ∏è Projet CestMonImage - R√®gles Sp√©cifiques

## üìå Contexte du Projet

Application Windows de watermarking d'images avec :
- Interface Tkinter
- Traitement d'images Pillow
- M√©tadonn√©es EXIF (piexif)
- Packaging PyInstaller

## üéØ R√®gles Critiques

### ‚ö†Ô∏è Chemins et Ressources
**INTERDIT** : Coder en dur des chemins de fichiers pour les sprites/backgrounds
**OBLIGATOIRE** : Tous les chemins doivent √™tre configurables via l'interface

```python
# ‚ùå INTERDIT - Chemin cod√© en dur
WATERMARK_ICON = "C:\\Users\\User\\Images\\icon.png"

# ‚úÖ CORRECT - Chemin dynamique
def get_resource_path(relative_path: str) -> str:
    try:
        base_path = sys._MEIPASS
    except AttributeError:
        base_path = os.path.abspath(".")
    return os.path.join(base_path, relative_path)
```

### Format de Sortie des Images
- Les images watermark√©es sont pr√©fix√©es par `watermarked_`
- Les images existantes avec ce pr√©fixe sont ignor√©es
- Les non-JPEG sont convertis en JPEG pour les m√©tadonn√©es EXIF

## üèóÔ∏è Architecture

### Classes Principales
```
WatermarkApp
‚îú‚îÄ‚îÄ __init__()          # Initialisation GUI
‚îú‚îÄ‚îÄ create_widgets()    # Cr√©ation interface
‚îú‚îÄ‚îÄ browse_folder()     # S√©lection dossier
‚îú‚îÄ‚îÄ choose_color()      # Choix couleur
‚îú‚îÄ‚îÄ apply_watermark()   # Application watermark
‚îú‚îÄ‚îÄ update_preview()    # Pr√©visualisation
‚îî‚îÄ‚îÄ hex_to_rgb()        # Utilitaire couleur
```

### Variables Tkinter
```python
self.folder_path = tk.StringVar()      # Chemin du dossier
self.copyright_text = tk.StringVar()   # Texte copyright
self.signature_text = tk.StringVar()   # Signature auteur
self.opacity = tk.IntVar()             # Transparence 0-100
self.position = tk.StringVar()         # Position du watermark
self.mosaic_mode = tk.BooleanVar()     # Mode mosa√Øque
self.font_size_percent = tk.DoubleVar() # Taille police %
```

## üìù M√©tadonn√©es EXIF

### Structure des Donn√©es Watermark
```python
watermark_info = {
    "text": str,              # Texte du copyright
    "signature": str,         # Signature de l'auteur
    "date_applied": str,      # ISO datetime
    "opacity": float,         # 0.0 - 1.0
    "position": str,          # top-left, bottom-right, etc.
    "is_mosaic": bool,        # Mode mosa√Øque activ√©
    "num_watermarks": int,    # Nombre de watermarks
    "font": str,              # Nom de la police
    "is_bold": bool,          # Police en gras
    "font_size_percent": float,
    "application": str,       # "CestMonImage"
    "version": str            # Version de l'app
}
```

### Champs EXIF Utilis√©s
| Champ | Utilisation |
|-------|-------------|
| `ExifIFD.UserComment` | JSON complet des m√©tadonn√©es |
| `ImageIFD.Copyright` | Texte copyright |
| `ImageIFD.Artist` | Signature auteur |
| `ImageIFD.Software` | "CestMonImage" |
| `ImageIFD.ImageDescription` | ID unique signature |

## üé® Interface Utilisateur

### Sections de l'Interface
1. **S√©lection du dossier** - Parcourir + Entry
2. **Options du Copyright** - Symbole, texte, nombre, mosa√Øque
3. **Style de Texte** - Police, gras
4. **Apparence** - Couleur, position, transparence, taille
5. **Pr√©visualisation** - Canvas avec preview
6. **Bouton d'action** - Appliquer le copyright

### Positions de Watermark
- `top-left`
- `top-right`
- `bottom-left`
- `bottom-right`
- `center`

### Symboles de Copyright
- `¬©`
- `¬Æ`
- `‚Ñ¢`
- `(c)`
- `All Rights Reserved`

## üì¶ Build et Distribution

### Commande PyInstaller
```bash
pyinstaller \
    --name=Application_Copyright_Images \
    --onefile \
    --windowed \
    --clean \
    --add-data=fonts;fonts \
    watermark_app.py
```

### Structure de Distribution
```
exe_final/
‚îú‚îÄ‚îÄ Application_Copyright_Images.exe
‚îî‚îÄ‚îÄ fonts/
    ‚îî‚îÄ‚îÄ arial.ttf
```

### D√©pendances Build
```
psutil>=5.9.0
pyinstaller>=5.13.0
pywin32>=306
pillow>=10.0.0
piexif>=1.1.3
winshell>=0.6
```

## üîÑ Flux de Traitement

```
1. S√©lection dossier
2. Configuration options (copyright, style, position)
3. Pr√©visualisation sur premi√®re image
4. Clic "Appliquer"
5. Pour chaque image:
   a. Ouvrir image
   b. Cr√©er calque watermark RGBA
   c. Dessiner texte + signature
   d. Fusionner calques
   e. Ajouter m√©tadonn√©es EXIF
   f. Sauvegarder watermarked_*
6. Afficher r√©sum√©
```

## ‚ö†Ô∏è Gestion des Erreurs

### Points de D√©faillance Courants
- Police non trouv√©e ‚Üí Fallback sur Arial
- Image corrompue ‚Üí Skip avec message
- Permissions fichier ‚Üí Message explicite
- Format non support√© ‚Üí Conversion JPEG

### Messages Utilisateur
- Toujours afficher une `messagebox` pour les erreurs
- Inclure les d√©tails techniques en mode debug
- Logger les erreurs dans la console pour le d√©veloppement
